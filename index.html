<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Camera Pose Game</title>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #cam { position:absolute; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:-1; }
  #menu { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; flex-direction:column; background:rgba(0,0,0,0.7); z-index:10; color:#fff; }
  #loading { margin-top:15px; font-size:20px; }
  #btnStart { padding:12px 25px; border:none; border-radius:8px; background:#ffbf00; font-size:18px; cursor:pointer; }
</style>
</head>
<body>

<!-- CAMERA VIDEO -->
<video id="cam" autoplay playsinline muted></video>

<!-- MENU -->
<div id="menu">
  <button id="btnStart">Start</button>
  <div id="loading">Waiting...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

<script>
let camVideo = document.getElementById("cam");
let btnStart = document.getElementById("btnStart");
let loading = document.getElementById("loading");
let menu = document.getElementById("menu");
let camReady = false;
let detector;

/* ---------------- CAMERA FIX ---------------- */
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: "user"
      },
      audio: false
    });

    camVideo.srcObject = stream;
    camVideo.play();

    await new Promise(resolve => {
      camVideo.onloadedmetadata = () => resolve();
    });

    camReady = true;
    loading.innerText = "Camera ready";

  } catch (err) {
    console.error("CAMERA ERROR:", err);
    alert("Không mở được camera. Hãy chạy file qua server và cho phép quyền camera.");
    loading.innerText = "Camera error";
  }
}

/* ---------------- MODEL LOAD ---------------- */
async function loadPoseModel() {
  detector = await poseDetection.createDetector(
    poseDetection.SupportedModels.MoveNet,
    { modelType: "SinglePose.Lightning" }
  );
}

/* ---------------- GAME PLACEHOLDER ---------------- */
function startGameSession() {
  console.log("Game started!");
  // Game loop giả lập
  requestAnimationFrame(gameLoop);
}

function spawnInitialBurst() {
  console.log("Spawn objects...");
}

async function gameLoop() {
  if (detector && camReady) {
    const poses = await detector.estimatePoses(camVideo);
    // xử lý pose ở đây
  }
  requestAnimationFrame(gameLoop);
}

/* -------------- START BUTTON FIX -------------- */
btnStart.onclick = async () => {
  loading.innerText = "Starting camera...";
  await startCamera();
  if (!camReady) return;

  loading.innerText = "Loading pose model...";
  await loadPoseModel();

  loading.innerText = "Ready";
  menu.style.display = "none";

  startGameSession();
  spawnInitialBurst();
};
</script>
</body>
</html>
